<Window x:Class="CostAnalysis.UI.DataExporter"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:CostAnalysis.UI"
        Title="Data Exporter" Width="1100" Height="750" ResizeMode="NoResize"
        WindowStartupLocation="CenterOwner" FontFamily="Segoe UI" Background="#FFF7F8FA"
        UseLayoutRounding="True" SnapsToDevicePixels="True">

    <Window.Resources>
        <Color x:Key="AccentColor">#2176FF</Color>
        <Color x:Key="AccentDark">#185FCC</Color>
        <SolidColorBrush x:Key="AccentBrush" Color="{StaticResource AccentColor}"/>
        <SolidColorBrush x:Key="AccentDarkBrush" Color="{StaticResource AccentDark}"/>
        <SolidColorBrush x:Key="MutedText" Color="#7A8590"/>

        <Style x:Key="Card" TargetType="Border">
            <Setter Property="Background" Value="White"/>
            <Setter Property="CornerRadius" Value="6"/>
            <Setter Property="Padding" Value="12"/>
            <Setter Property="Margin" Value="6"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
            <Setter Property="BorderBrush" Value="#E6E9EE"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="ClipToBounds" Value="True"/>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect Color="#22000000" BlurRadius="8" ShadowDepth="2"/>
                </Setter.Value>
            </Setter>
        </Style>

        <Style x:Key="InnerPanel" TargetType="Border">
            <Setter Property="CornerRadius" Value="4"/>
            <Setter Property="BorderBrush" Value="#E6E9EE"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="8"/>
            <Setter Property="Margin" Value="0"/>
            <Setter Property="Background" Value="#FFFFFFFF"/>
            <Setter Property="SnapsToDevicePixels" Value="True"/>
        </Style>

        <Style TargetType="ListBox" x:Key="InnerList">
            <Setter Property="BorderBrush" Value="#E6E9EE"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="6"/>
            <Setter Property="Margin" Value="0,0,0,8"/>
        </Style>
    </Window.Resources>

    <Grid Margin="12">
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="240"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="360"/>
        </Grid.ColumnDefinitions>

        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="72"/>
        </Grid.RowDefinitions>

        <!-- Title -->
        <StackPanel Grid.Row="0" Grid.ColumnSpan="3" Orientation="Horizontal" VerticalAlignment="Center" Margin="6">
            <TextBlock Text="Data Exporter" FontSize="20" FontWeight="Bold" Foreground="{StaticResource AccentDarkBrush}"/>
            <TextBlock Text="  •  BOQ and QA-QC export" VerticalAlignment="Center" Foreground="{StaticResource MutedText}" Margin="8,2,0,0"/>
        </StackPanel>

        <!-- LEFT: Model Category (fixed scrolling!) -->
        <Border Grid.Row="1" Grid.Column="0" Style="{StaticResource Card}">
            <Border Style="{StaticResource InnerPanel}">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*" />
                    </Grid.RowDefinitions>

                    <TextBlock Text="Model Category" FontWeight="SemiBold" Margin="0,0,0,8"/>

                    <ListBox x:Name="LV_ModelCat"
                             Grid.Row="1"
                             DisplayMemberPath="Name"
                             SelectedValuePath="Id"
                             Style="{StaticResource InnerList}"
                             ScrollViewer.VerticalScrollBarVisibility="Auto"
                             VerticalAlignment="Stretch"
                             />
                </Grid>
            </Border>
        </Border>

        <!-- CENTER: Types -->
        <Border Grid.Row="1" Grid.Column="1" Style="{StaticResource Card}">
            <Border Style="{StaticResource InnerPanel}">
                <DockPanel LastChildFill="True">
                    <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="0,0,0,8" VerticalAlignment="Center">
                        <CheckBox x:Name="CB_SelectAllTypes" Content="Select all" VerticalAlignment="Center" Margin="0,0,12,0" Checked="CB_SelectAllTypes_Checked" Unchecked="CB_SelectAllTypes_Unchecked"/>
                        <TextBox x:Name="TB_TypeSearch" Width="180" Height="30" Margin="0,0,8,0" VerticalAlignment="Center" TextChanged="TB_TypeSearch_TextChanged" Padding="6"/>
                        <TextBlock Text="{Binding TypeEntries.Count, RelativeSource={RelativeSource AncestorType=Window}, StringFormat='  Types: {0}'}" VerticalAlignment="Center" Foreground="{StaticResource MutedText}" Margin="8,2,0,0"/>
                    </StackPanel>

                    <DataGrid x:Name="DG_Types" AutoGenerateColumns="False" CanUserAddRows="False" IsReadOnly="False"
                              ItemsSource="{Binding TypeEntries}" SelectionMode="Single" SelectionUnit="FullRow"
                              SelectedItem="{Binding SelectedType, Mode=TwoWay}"
                              GridLinesVisibility="All" HorizontalGridLinesBrush="#E6E9EE" VerticalGridLinesBrush="#E6E9EE"
                              Margin="0,0,0,8" SnapsToDevicePixels="True" BorderBrush="#E6E9EE" BorderThickness="1">
                        <DataGrid.Columns>
                            <DataGridCheckBoxColumn Header="Export" Binding="{Binding IsSelected, Mode=TwoWay}" Width="60"/>
                            <DataGridTextColumn Header="Type Name" Binding="{Binding Name}" Width="*" IsReadOnly="True"/>
                            <DataGridTextColumn Header="Count" Binding="{Binding InstanceCount}" Width="80" IsReadOnly="True"/>
                            <DataGridCheckBoxColumn Header="Itemize" Binding="{Binding ExportInstances, Mode=TwoWay}" Width="80" />
                            <DataGridCheckBoxColumn Header="QA-QC" Binding="{Binding QAQCEnabled, Mode=TwoWay}" Width="80" />
                        </DataGrid.Columns>
                    </DataGrid>

                    <Expander Header="Instances (selected type)" IsExpanded="{Binding IsChecked, ElementName=CHK_ShowInstances}" Margin="0,8,0,0" Name="EXP_Instances">
                        <ListView x:Name="LV_Instances" Height="180" Margin="0,8,0,8" Padding="6" BorderBrush="#E6E9EE" BorderThickness="1"
                                  ItemsSource="{Binding SelectedType.Instances, RelativeSource={RelativeSource AncestorType=Window}}">
                            <ListView.ItemTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding Id}" Width="60"/>
                                        <TextBlock Text="{Binding Name}" Width="220"/>
                                        <TextBlock Text="{Binding Level}" Width="120"/>
                                        <TextBlock Text="{Binding InfoSummary}" Foreground="{StaticResource MutedText}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </ListView.ItemTemplate>
                        </ListView>
                    </Expander>
                </DockPanel>
            </Border>
        </Border>

        <!-- RIGHT (same as before)… -->
        <Border Grid.Row="1" Grid.Column="2" Style="{StaticResource Card}">
            <Border Style="{StaticResource InnerPanel}">
                <StackPanel>
                    <TextBlock Text="Export Options" FontWeight="SemiBold" Margin="0,0,0,8"/>

                    <TabControl x:Name="TAB_Mode" Margin="0,0,0,8">
                        <TabItem Header="BOQ">
                            <StackPanel Margin="6">
                                <StackPanel Orientation="Horizontal" Margin="0,0,0,6">
                                    <CheckBox x:Name="CHK_Count" Content="Count" IsChecked="True" Margin="0,0,8,0"/>
                                    <CheckBox x:Name="CHK_Length" Content="Length" Margin="0,0,8,0"/>
                                    <CheckBox x:Name="CHK_Area" Content="Area" Margin="0,0,8,0"/>
                                    <CheckBox x:Name="CHK_Volume" Content="Volume"/>
                                </StackPanel>

                                <CheckBox x:Name="CHK_BreakdownByLevel" Content="Breakdown aggregated BOQ by Level" Margin="0,6,0,0"/>
                                <CheckBox x:Name="CHK_ItemizeAll" Content="Itemize instances for all selected types" Margin="0,6,0,0"/>

                                <TextBlock Text="CSV Options" FontWeight="SemiBold" Margin="0,12,0,6"/>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="Decimal places:" VerticalAlignment="Center" Margin="0,0,8,0"/>
                                    <ComboBox x:Name="CB_Decimals" Width="80" SelectedIndex="2">
                                        <ComboBoxItem Content="0"/>
                                        <ComboBoxItem Content="1"/>
                                        <ComboBoxItem Content="2"/>
                                        <ComboBoxItem Content="3"/>
                                        <ComboBoxItem Content="4"/>
                                    </ComboBox>
                                </StackPanel>
                            </StackPanel>
                        </TabItem>

                        <TabItem Header="QA-QC">
                            <StackPanel Margin="6">
                                <TextBlock Text="When QA-QC mode is active, choose which instance parameters should be exported for selected types." TextWrapping="Wrap" Foreground="{StaticResource MutedText}" Margin="0,0,0,8"/>
                                <TextBlock Text="Selected Type Parameters" FontWeight="SemiBold" />
                                <ListBox x:Name="LB_TypeParameters" Height="200" SelectionMode="Extended" Margin="0,6,0,6" Padding="6" BorderBrush="#E6E9EE" BorderThickness="1"/>
                                <TextBlock Text="Note: select the types and enable 'QA-QC' in the center grid for those types." Foreground="{StaticResource MutedText}" FontSize="12"/>
                            </StackPanel>
                        </TabItem>
                    </TabControl>

                    <TextBlock Text="Preview / Geometry (selected item)" FontWeight="SemiBold" Margin="0,6,0,6"/>
                    <ListBox x:Name="LV_GeometryPreview" Height="281" Margin="0,8,0,8" Padding="6" BorderBrush="#E6E9EE" BorderThickness="1"/>
                </StackPanel>
            </Border>
        </Border>

        <!-- Divider -->
        <Border Grid.Row="2" Grid.ColumnSpan="3" VerticalAlignment="Top"
                Height="1" Margin="6,0,6,0" Background="#E6E9EE" IsHitTestVisible="False"/>

        <!-- Footer -->
        <Grid Grid.Row="2" Grid.ColumnSpan="3" Margin="0,8,0,0">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Vertical" VerticalAlignment="Center" Margin="10,0,0,0">
                <TextBlock Foreground="{StaticResource MutedText}" FontSize="12">
                    <Run Text="If you encounter errors or technical problems, please contact:" />
                </TextBlock>
                <TextBlock FontSize="12">
                    <Hyperlink NavigateUri="mailto:mohammad.shahnawaz@expocitydubai.ae" RequestNavigate="SupportMail_RequestNavigate">
                        <Run Text="mohammad.shahnawaz@expocitydubai.ae"/>
                    </Hyperlink>
                </TextBlock>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="6">
                <Button Content="Highlight Selected Category" Width="180" Margin="0,0,8,0" Click="HighLight_Click"/>
                <Button Content="Export" Width="140" Background="{StaticResource AccentBrush}" Foreground="White" Click="Export_Click"/>
                <Button Content="Close" Width="110" Margin="8,0,0,0" Click="Close_Click"/>
            </StackPanel>
        </Grid>
    </Grid>
</Window>
